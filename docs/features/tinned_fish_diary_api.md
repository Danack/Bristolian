# Tinned Fish Diary API

API for looking up tinned fish product information by barcode.

## Feature Description

This feature provides a REST API for the Tinned Fish Diary mobile app to look up product information by barcode. It first checks the canonical database, then optionally fetches from external APIs (OpenFoodFacts) with proper copyright attribution.

## API Endpoints

### Product Lookup

- **Path**: `GET /api/tfd/v1/products/barcode/{barcode}`
- **Query Parameters**: `fetch_external` (boolean, optional, default: true)
- **Authentication**: Bearer token

### Token Generation (Admin Only)

- **Path**: `POST /api/tfd/v1/admin/api-token/generate`
- **Authentication**: Admin login required (for generating tokens)
- **Body Parameters**: 
  - `name` (string, required) - Name/identifier for the token (e.g., "John's iPhone", "Test Device")
- **Response**: JSON with `token`, `name`, `qr_code_url`, and `created_at`

## Authentication

The API uses Bearer token authentication for mobile app clients.

API tokens can be generated by admin users and used for authentication.

#### Obtaining an API Token

1. **Admin generates token**:
   - Log in as an admin user
   - Navigate to the Tinned Fish Products admin page
   - Enter a name for the token (e.g., "John's iPhone", "Test Device")
   - Click "Generate API Token"
   - A QR code will be displayed containing the token

2. **Mobile app scans QR code**:
   - Use the mobile app's QR code scanner to read the token from the QR code
   - Store the token securely in the app's local storage

#### Using the API Token

Include the token in the `Authorization` header of all API requests:

```
Authorization: Bearer <your-token-here>
```

#### Example Request with Bearer Token

```javascript
async function lookupProductWithToken(barcode, apiToken) {
  const response = await fetch(
    `http://local.api.bristolian.org/api/tfd/v1/products/barcode/${barcode}?fetch_external=true`,
    {
      headers: {
        'Authorization': `Bearer ${apiToken}`
      }
    }
  );
  
  if (!response.ok) {
    throw new Error(`API request failed: ${response.status}`);
  }
  
  return await response.json();
}

// Usage
const token = 'your-api-token-here';
const product = await lookupProductWithToken('3017620422003', token);
console.log(product);
```

#### Token Properties

- **Format**: Base64-encoded random string (~44 characters)
- **Expiry**: Tokens do not expire - they remain valid until manually revoked
- **Revocation**: Tokens can be revoked by admin users (future feature)
- **Security**: Treat tokens as secrets - never log or expose them in client-side code
- **Scope**: Tokens authenticate API requests but do not provide session context

#### Important Notes for Token Authentication

- **Header Format**: Must use `Authorization: Bearer <token>` format (case-sensitive)
- **Token Storage**: Store tokens securely in the mobile app (e.g., encrypted keychain/keystore)
- **Token Sharing**: Each token should be associated with a specific device/user via the name field
- **GET Requests**: Currently, GET requests to product lookup endpoints do not require authentication (tokens are for future POST endpoints or when GET endpoints need protection)

## Important Files

### Database
- `db/migrations/29_tinned_fish_product.php` - Migration for the canonical product table
- `db/migrations/32_api_token.php` - Migration for API token table

### Models
- `src/Bristolian/Model/TinnedFish/Product.php` - Product data model
- `src/Bristolian/Model/TinnedFish/Copyright.php` - Copyright attribution model
- `src/Bristolian/Model/TinnedFish/ProductError.php` - Error response model
- `src/Bristolian/Model/Types/ApiToken.php` - API token model

### Repository
- `src/Bristolian/Repo/TinnedFishProductRepo/TinnedFishProductRepo.php` - Repository interface
- `src/Bristolian/Repo/TinnedFishProductRepo/PdoTinnedFishProductRepo.php` - PDO implementation
- `src/Bristolian/Repo/ApiTokenRepo/ApiTokenRepo.php` - API token repository interface
- `src/Bristolian/Repo/ApiTokenRepo/PdoApiTokenRepo.php` - API token repository implementation

### Services
- `src/Bristolian/Service/TinnedFish/OpenFoodFactsFetcher.php` - External API fetcher
- `src/Bristolian/Service/TinnedFish/OpenFoodFactsApiException.php` - API exception
- `src/functions_common.php` - `generateSecureToken()` for API token generation
- `src/functions_tinned_fish.php` - Data normalization functions

### Parameters
- `src/Bristolian/Parameters/TinnedFish/BarcodeLookupParams.php` - Request parameters
- `src/Bristolian/Parameters/TinnedFish/GenerateApiTokenParams.php` - Token generation parameters
- `src/Bristolian/Parameters/PropertyType/Barcode.php` - Barcode validation type
- `src/Bristolian/Parameters/PropertyType/OptionalBoolDefaultTrue.php` - Bool param type
- `src/Bristolian/Parameters/ProcessRule/StringToBoolDefaultTrue.php` - Bool process rule

### Responses
- `src/Bristolian/Response/TinnedFish/ProductLookupResponse.php` - Success response
- `src/Bristolian/Response/TinnedFish/ProductNotFoundResponse.php` - 404 response
- `src/Bristolian/Response/TinnedFish/InvalidBarcodeResponse.php` - 400 response
- `src/Bristolian/Response/TinnedFish/ExternalApiErrorResponse.php` - 502 response
- `src/Bristolian/Response/TinnedFish/GenerateApiTokenResponse.php` - Token generation response

### Controller
- `src/Bristolian/ApiController/TinnedFish.php` - Main controller

### Middleware
- `src/Bristolian/Middleware/PermissionsCheckHtmlMiddleware.php` - Handles both session and Bearer token authentication

### Configuration
- `api/src/api_routes.php` - Route registration
- `api/src/api_injection_params.php` - Dependency injection config
- `test/test_injection_params.php` - Test dependency injection config

### Tests
- `test/BristolianTest/Repo/TinnedFishProductRepo/PdoTinnedFishProductRepoTest.php` - Repository tests
- `test/BristolianTest/Service/TinnedFish/ProductNormalizerTest.php` - Normalizer tests
- `test/BristolianTest/Parameters/TinnedFish/BarcodeLookupParamsTest.php` - Parameter tests
- `test/BristolianTest/Parameters/ProcessRule/StringToBoolDefaultTrueTest.php` - ProcessRule tests
- `test/BristolianTest/Model/TinnedFish/ProductErrorTest.php` - ProductError model tests
- `test/BristolianTest/Model/TinnedFish/CopyrightTest.php` - Copyright model tests


## Companies

https://www.labelleiloise.fr/