version: "3"
services:
  caddy:
    build: containers/caddy
    # container_name: caddy
    # image: caddy:latest
    volumes:
      - .:/var/app
#    ports:
#      - 80:80
#      - 8080:80
    depends_on:
     - php_fpm
    networks:
      default_network:
  chrome_headless:
    image: alpeware/chrome-headless-trunk
    ports:
      - "9222:9222"
    cap_add:
      - SYS_ADMIN
    environment:
      - CHROME_OPTS=--window-size="800,800"
    networks:
      default_network:
    security_opt:
      - seccomp:unconfined
      #extra_hosts:
      #      - "local.phpimagick.com:imagick_php_backend"
      # - "local.phpimagick.com:162.242.195.82"
  db:
    image: mysql:8.0.30
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: PrJaGpnNSzSLW8p8
      MYSQL_DATABASE: bristolian
      MYSQL_USER: bristolian
      MYSQL_PASSWORD: p5ffrKSk4mPqN8vH
      MYSQL_ROOT_HOST: "%"
    networks:
      default_network:
    volumes:
      - ./docker/mysql/config/my.cnf:/etc/mysql/my.cnf
      - ./data/mysql:/var/lib/mysql
      - ./data/mysql_import:/docker-entrypoint-initdb.d
  installer:
    build: containers/installer
    environment:
      - COMPOSER_CACHE_DIR=/var/app/var/cache/composer
      - COMPOSER_ALLOW_SUPERUSER=1
    networks:
      default_network:
    volumes:
      - .:/var/app
  js_builder:
    build: containers/js_builder
    volumes:
      - .:/var/app
  sass_dev_builder:
    build: containers/sass_dev_builder
  #  ports:
  #    - 8888:8888
    volumes:
      - .:/var/app
  php_fpm:
    build: containers/php_fpm
    image: bristolian_php_fpm
#    depends_on:
#      - db
    environment:
      - COMPOSER_CACHE_DIR=/var/app/var/cache/composer
      - COMPOSER_ALLOW_SUPERUSER=1
    networks:
      default_network:
    volumes:
      - .:/var/app
  php_fpm_debug:
    build: containers/php_fpm_debug
    environment:
      - COMPOSER_CACHE_DIR=/var/app/var/cache/composer
      - COMPOSER_ALLOW_SUPERUSER=1
      - PHP_IDE_CONFIG=serverName=BRISTOLIAN_DEBUG
    depends_on:
      - php_fpm
    networks:
      default_network:
    volumes:
      - .:/var/app
  redis:
    image: redis:6.2.4
    volumes:
      - .:/var/app
    command: ["redis-server", "/var/app/containers/redis/config/redis.conf"]
    networks:
      default_network:
  supervisord:
    build: containers/supervisord
    depends_on:
      - redis
    volumes:
      - .:/var/app
  varnish:
    build: containers/varnish
    environment:
      CACHE_SIZE: 128m
    networks:
      default_network:
    volumes:
      - ./:/var/app
    depends_on:
      - caddy
      - php_fpm
networks:
  default_network:

